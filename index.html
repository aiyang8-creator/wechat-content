<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeChat Automator Pro - å…¬ä¼—å·è‡ªåŠ¨åŒ–å·¥å‚</title>
    
    <!-- Core Libraries -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- Tailwind Config -->
    <script>
        (function() {
            const myConfig = {
                theme: {
                    extend: {
                        colors: {
                            brand: 'var(--w-accent-color)',
                            bg: 'var(--w-bg-color)',
                            surface: 'var(--w-surface-color)',
                            text: 'var(--w-text-color)',
                            'text-sec': 'var(--w-text-sec-color)',
                        },
                        boxShadow: {
                            'ios': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                        }
                    }
                }
            };
            function applyTailwindConfig() {
                if (typeof tailwind !== 'undefined') {
                    tailwind.config = myConfig;
                }
            }
            if (typeof tailwind !== 'undefined') {
                applyTailwindConfig();
            } else {
                window.addEventListener('load', applyTailwindConfig);
                const checkInterval = setInterval(() => {
                    if (typeof tailwind !== 'undefined') {
                        applyTailwindConfig();
                        clearInterval(checkInterval);
                    }
                }, 100);
                setTimeout(() => clearInterval(checkInterval), 5000);
            }
        })();
    </script>

    <!-- Custom Styles -->
    <style>
        :root {
            /* Default Theme (Classic White) */
            --w-accent-color: #07c160; 
            --w-bg-color: #f3f4f6;
            --w-surface-color: #ffffff;
            --w-text-color: #1f2937;
            --w-text-sec-color: #6b7280;
            --w-border-color: #e5e7eb;
        }

        [data-theme="tech"] { --w-accent-color: #3b82f6; --w-bg-color: #0f172a; --w-surface-color: #1e293b; --w-text-color: #f1f5f9; --w-text-sec-color: #94a3b8; --w-border-color: #334155; }
        [data-theme="warm"] { --w-accent-color: #d97706; --w-bg-color: #fef3c7; --w-surface-color: #fffbeb; --w-text-color: #451a03; --w-text-sec-color: #92400e; --w-border-color: #fde68a; }
        [data-theme="dark"] { --w-accent-color: #8b5cf6; --w-bg-color: #18181b; --w-surface-color: #27272a; --w-text-color: #e4e4e7; --w-text-sec-color: #a1a1aa; --w-border-color: #3f3f46; }

        body {
            background-color: var(--w-bg-color);
            color: var(--w-text-color);
            transition: background-color 0.3s, color 0.3s;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        .console-scroll::-webkit-scrollbar { width: 6px; }
        .console-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        .console-scroll::-webkit-scrollbar-thumb { background: var(--w-accent-color); border-radius: 3px; }

        .wx-content { font-size: 16px; line-height: 1.75; letter-spacing: 0.05em; text-align: justify; color: #333333; }
        .wx-content p { margin-bottom: 1.5em; min-height: 1em; }
        .wx-content h2 { font-size: 18px; font-weight: bold; border-left: 4px solid var(--w-accent-color); padding-left: 10px; margin-top: 2em; margin-bottom: 1em; line-height: 1.4; color: #000; }
        .wx-content blockquote { background: #f7f7f7; border-radius: 4px; padding: 1em; margin: 1.5em 0; color: #666; font-size: 14px; border-left: 3px solid #ddd; }
        .wx-content strong { color: var(--w-accent-color); font-weight: 700; }
        .wx-content ul { padding-left: 1em; margin-bottom: 1.5em; }
        .wx-content li { list-style-type: disc; margin-bottom: 0.5em; color: #444; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. Constants ---
        const DEFAULT_API_KEY = ""; 
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        
        // --- 2. Utilities ---
        const fetchWithRetry = async (url, options = {}, logCallback, maxRetries = 5) => {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) {
                        const waitTime = (attempt + 1) * 5000;
                        logCallback(`âš ï¸ è§¦å‘é™æµ (429)ï¼Œç­‰å¾… ${waitTime/1000}ç§’åç¬¬ ${attempt + 1} æ¬¡é‡è¯•...`);
                        await new Promise(r => setTimeout(r, waitTime));
                        attempt++;
                        continue;
                    }
                    if (response.status >= 500) {
                        const waitTime = Math.pow(2, attempt) * 1000;
                        logCallback(`âš ï¸ æœåŠ¡å™¨ç¹å¿™ (${response.status})ï¼Œç­‰å¾… ${waitTime/1000}ç§’åç¬¬ ${attempt + 1} æ¬¡é‡è¯•...`);
                        await new Promise(r => setTimeout(r, waitTime));
                        attempt++;
                        continue;
                    }
                    if (response.status >= 400 && response.status < 500) {
                        const errText = await response.text();
                        throw new Error(`è¯·æ±‚è¢«æ‹’ç» (${response.status}): ${errText}`);
                    }
                    return response;
                } catch (error) {
                    if (attempt === maxRetries - 1) throw error;
                    const waitTime = Math.pow(2, attempt) * 1000;
                    logCallback(`âš ï¸ ç½‘ç»œé”™è¯¯ (${error.message})ï¼Œ${waitTime/1000}ç§’åé‡è¯•...`);
                    await new Promise(r => setTimeout(r, waitTime));
                    attempt++;
                }
            }
        };

        // --- 3. Icons ---
        const Icons = {
            Settings: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Play: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Copy: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
            Image: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>,
            Check: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Theme: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Key: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>,
            Cloud: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.5 19c0-1.7-1.3-3-3-3h-11a3 3 0 0 1-3-3c0-1.7 1.3-3 3-3 0-1.4 0-2.8.3-4.1A6 6 0 0 1 12 5c2.9 0 5.4 2 6 4.9 2.5.3 4.5 2.5 4.5 5.1 0 2.8-2.2 5-5 5z"/></svg>,
            Refresh: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
        };

        // --- 4. Main Components ---

        const Toast = ({ message, show }) => {
            if (!show) return null;
            return (
                <div className="fixed top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg z-50 flex items-center gap-2 animate-bounce">
                    <Icons.Check />
                    <span>{message}</span>
                </div>
            );
        };

        const App = () => {
            const [apiKey, setApiKey] = React.useState(() => localStorage.getItem('wechat_automator_api_key') || "");
            const [showCustomKey, setShowCustomKey] = React.useState(() => !localStorage.getItem('wechat_automator_api_key'));
            const [topic, setTopic] = React.useState("");
            const [logs, setLogs] = React.useState([]);
            const [loading, setLoading] = React.useState(false);
            const [article, setArticle] = React.useState(null); 
            // article: { titles: [], digest: '', sections: [], coverUrl, coverPrompt }
            const [currentTitleIndex, setCurrentTitleIndex] = React.useState(0);
            
            const [theme, setTheme] = React.useState('classic');
            const [toast, setToast] = React.useState({ show: false, msg: '' });

            const logsEndRef = React.useRef(null);
            const previewRef = React.useRef(null);

            React.useEffect(() => { logsEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [logs]);
            React.useEffect(() => { document.body.setAttribute('data-theme', theme); }, [theme]);
            React.useEffect(() => {
                if (apiKey) localStorage.setItem('wechat_automator_api_key', apiKey);
                else localStorage.removeItem('wechat_automator_api_key');
            }, [apiKey]);

            const addLog = (msg) => {
                const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
                setLogs(prev => [...prev, `[${time}] ${msg}`]);
            };

            const showToast = (msg) => {
                setToast({ show: true, msg });
                setTimeout(() => setToast({ show: false, msg: '' }), 3000);
            };

            const cycleTitle = () => {
                if (article && article.titles.length > 0) {
                    setCurrentTitleIndex((prev) => (prev + 1) % article.titles.length);
                }
            };

            const copyDigest = async () => {
                if (article && article.digest) {
                    try {
                        await navigator.clipboard.writeText(article.digest);
                        showToast("æ‘˜è¦å·²å¤åˆ¶");
                    } catch (e) {
                        showToast("å¤åˆ¶å¤±è´¥");
                    }
                }
            };

            // Image Generator
            const generateImage = async (prompt, isCover = false) => {
                const enhancedPrompt = `${prompt}, high quality, 8k, realistic, detailed, photorealistic`;
                const seed = Math.floor(Math.random() * 1000000);
                const width = isCover ? 1080 : 1280;
                const height = isCover ? 460 : 720; 
                const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(enhancedPrompt)}?width=${width}&height=${height}&seed=${seed}&nologo=true&model=flux`;

                addLog(`ğŸ¨ å¼€å§‹ç»˜åˆ¶${isCover ? 'å°é¢' : 'æ’å›¾'}: ${prompt.substring(0, 15)}...`);
                try {
                    const res = await fetchWithRetry(url, {}, addLog);
                    if (!res.ok) throw new Error("Image fetch failed");
                    const blob = await res.blob();
                    const objectUrl = URL.createObjectURL(blob);
                    addLog(`âœ… ${isCover ? 'å°é¢' : 'æ’å›¾'}ç»˜åˆ¶æˆåŠŸ`);
                    return objectUrl;
                } catch (e) {
                    addLog(`âŒ ç»˜å›¾å¤±è´¥ï¼Œä½¿ç”¨å ä½å›¾: ${e.message}`);
                    return `data:image/svg+xml;charset=UTF-8,%3Csvg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg"%3E%3Crect width="100%25" height="100%25" fill="%23eee"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="24" fill="%23aaa"%3EImage Generation Failed%3C/text%3E%3C/svg%3E`;
                }
            };

            const handleStart = async () => {
                if (!topic) return showToast("è¯·è¾“å…¥é€‰é¢˜");
                const currentKey = apiKey;
                if (!currentKey) {
                    setShowCustomKey(true);
                    return showToast("è¯·å…ˆé…ç½® API Key");
                }
                
                setLoading(true);
                setLogs([]);
                setArticle(null);
                setCurrentTitleIndex(0);
                addLog("ğŸš€ ä»»åŠ¡å¯åŠ¨...");

                try {
                    addLog("ğŸ§  Gemini æ­£åœ¨æ„æ€...");
                    
                    const systemPrompt = `
                    ä½ æ˜¯ä¸€ä¸ªæ“…é•¿è®²æ•…äº‹çš„å¾®ä¿¡å…¬ä¼—å·ä¸»ç†äººã€‚è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„ã€Topicã€‘åˆ›ä½œä¸€ç¯‡é«˜è´¨é‡å›¾æ–‡ã€‚

                    ã€é£æ ¼åŸºè°ƒã€‘ï¼š
                    1. **è€å‹èŠå¤©é£**ï¼šè¯­æ°”è½»æ¾ã€èˆ’é€‚ï¼Œåƒæœ‹å‹åœ¨å’–å•¡é¦†èŠå¤©ã€‚
                    2. **æ•…äº‹ä¸ºä¸»**ï¼š80% çœŸå®æ•…äº‹/ç»†èŠ‚ï¼Œ20% é“ç†ã€‚æ‹’ç»çˆ¹å‘³è¯´æ•™ã€‚
                    3. **æƒ…æ„Ÿå…±é¸£**ï¼šå¤šç”¨â€œæˆ‘ä»¬â€ï¼Œå…³æ³¨è¯»è€…æƒ…ç»ªã€‚

                    ã€å…³é”®è¦æ±‚ã€‘ï¼š
                    1. **ä¸€è‡´æ€§**ï¼šå¦‚æœæ ‡é¢˜å«æ•°å­—ï¼ˆå¦‚â€œ3ä¸ªä¹ æƒ¯â€ï¼‰ï¼Œæ­£æ–‡ç»“æ„å¿…é¡»ä¸¥æ ¼å¯¹åº”ã€‚
                    2. **æ‘˜è¦å¿…å¡«**ï¼šå¿…é¡»ç”Ÿæˆä¸€ä¸ª120å­—ä»¥å†…çš„ digestï¼Œç”¨äºå…¬ä¼—å·æ‘˜è¦ï¼Œè¦å¸å¼•äººç‚¹å‡»ã€‚
                    3. **å¤šæ ‡é¢˜**ï¼šå¿…é¡»æä¾›5ä¸ªä¸åŒè§’åº¦çš„çˆ†æ¬¾æ ‡é¢˜ä¾›é€‰æ‹©ã€‚
                    
                    ã€JSONæ ¼å¼ã€‘ï¼š
                    è¿”å›çº¯ JSONï¼ŒåŒ…å«ï¼š
                    - 'digest': string (120å­—ä»¥å†…æ‘˜è¦)
                    - 'titles': string[] (5ä¸ªçˆ†æ¬¾æ ‡é¢˜æ•°ç»„)
                    - 'coverPrompt': string (è‹±æ–‡å°é¢æç¤ºè¯)
                    - 'sections': Array<{ type: 'text'|'image_prompt', content: string }>
                    
                    ã€æ’ç‰ˆã€‘ï¼š
                    ä½¿ç”¨ HTML æ ‡ç­¾ï¼š<strong>, <h2>, <blockquote>, <ul><li>ã€‚ä¸¥ç¦ Markdownã€‚
                    `;

                    const response = await fetchWithRetry(
                        `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${currentKey}`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: `Topic: ${topic}` }] }],
                                systemInstruction: { parts: [{ text: systemPrompt }] },
                                generationConfig: { responseMimeType: "application/json" }
                            })
                        },
                        addLog
                    );

                    const data = await response.json();
                    const resultText = data.candidates[0].content.parts[0].text;
                    let parsedData = JSON.parse(resultText);

                    // Data Cleaning
                    if (parsedData.sections) {
                        parsedData.sections = parsedData.sections.map(section => {
                            if (section.type === 'text') {
                                let cleanContent = section.content;
                                cleanContent = cleanContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                                cleanContent = cleanContent.replace(/^##\s+(.*$)/gm, '<h2>$1</h2>');
                                cleanContent = cleanContent.replace(/^\*\s+(.*$)/gm, '<ul><li>$1</li></ul>');
                                return { ...section, content: cleanContent };
                            }
                            return section;
                        });
                    }

                    addLog("ğŸ“ å¤§çº²å·²ç”Ÿæˆï¼Œå‡†å¤‡æ¸²æŸ“...");
                    
                    const initialSections = parsedData.sections.map((s, i) => ({
                        ...s,
                        id: i,
                        isLoading: s.type === 'image_prompt',
                        url: null
                    }));

                    setArticle({
                        titles: parsedData.titles || ["é»˜è®¤æ ‡é¢˜"],
                        digest: parsedData.digest || "æš‚æ— æ‘˜è¦",
                        coverUrl: null,
                        coverPrompt: parsedData.coverPrompt,
                        sections: initialSections
                    });

                    // Sequential Image Gen
                    const coverUrl = await generateImage(parsedData.coverPrompt, true);
                    setArticle(prev => ({ ...prev, coverUrl }));
                    
                    for (let i = 0; i < initialSections.length; i++) {
                        const section = initialSections[i];
                        if (section.type === 'image_prompt') {
                            await new Promise(r => setTimeout(r, 1000));
                            const imgUrl = await generateImage(section.content, false);
                            setArticle(prev => ({
                                ...prev,
                                sections: prev.sections.map(s => s.id === section.id ? { ...s, url: imgUrl, isLoading: false } : s)
                            }));
                        }
                    }

                    addLog("âœ¨ å…¨éƒ¨ä»»åŠ¡å®Œæˆï¼");

                } catch (error) {
                    addLog(`âŒ è‡´å‘½é”™è¯¯: ${error.message}`);
                    console.error(error);
                } finally {
                    setLoading(false);
                }
            };

            const copyToWeChat = async () => {
                if (!previewRef.current) return;
                addLog("ğŸ“‹ æ­£åœ¨å¤„ç†å¯Œæ–‡æœ¬...");
                showToast("æ­£åœ¨å‡†å¤‡å›¾ç‰‡...");
                
                const clone = previewRef.current.cloneNode(true);
                const images = clone.querySelectorAll('img');
                
                // Base64 Conversion
                for (let img of images) {
                    try {
                        const response = await fetch(img.src);
                        const blob = await response.blob();
                        const base64 = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result);
                            reader.readAsDataURL(blob);
                        });
                        img.src = base64;
                    } catch (e) {
                        console.warn('Image conversion failed', e);
                    }
                }

                // Inline Styles
                const processStyles = (root) => {
                    const allElements = root.querySelectorAll('*');
                    const brandColor = '#07c160';
                    allElements.forEach(el => {
                        const tagName = el.tagName.toLowerCase();
                        el.removeAttribute('class');
                        if (tagName === 'p') {
                            el.style.marginBottom = '1.5em';
                            el.style.lineHeight = '1.75';
                            el.style.fontSize = '16px';
                            el.style.color = '#333333';
                            el.style.textAlign = 'justify';
                        }
                        if (tagName === 'h2') {
                            el.style.fontSize = '18px';
                            el.style.fontWeight = 'bold';
                            el.style.borderLeft = `4px solid ${brandColor}`;
                            el.style.paddingLeft = '10px';
                            el.style.marginTop = '2em';
                            el.style.marginBottom = '1em';
                            el.style.lineHeight = '1.4';
                            el.style.color = '#000000';
                        }
                        if (tagName === 'blockquote') {
                            el.style.background = '#f7f7f7';
                            el.style.borderLeft = '4px solid #dddddd';
                            el.style.padding = '1em';
                            el.style.margin = '1.5em 0';
                            el.style.color = '#666666';
                            el.style.fontSize = '14px';
                            el.style.borderRadius = '4px';
                        }
                        if (tagName === 'strong' || tagName === 'b') {
                            el.style.color = brandColor;
                            el.style.fontWeight = '700';
                        }
                        if (tagName === 'ul') { el.style.paddingLeft = '20px'; el.style.margin = '1em 0'; }
                        if (tagName === 'li') { el.style.marginBottom = '0.5em'; el.style.listStyleType = 'disc'; }
                        if (tagName === 'img') {
                            el.style.maxWidth = '100%';
                            el.style.height = 'auto';
                            el.style.display = 'block';
                            el.style.margin = '10px auto';
                            el.style.borderRadius = '6px';
                            el.setAttribute('data-src', el.src); 
                        }
                    });
                    root.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif";
                    root.style.fontSize = '16px';
                    root.style.lineHeight = '1.75';
                    root.style.color = '#333333';
                };
                
                processStyles(clone);
                const htmlContent = clone.outerHTML;

                try {
                    const blobHtml = new Blob([htmlContent], { type: "text/html" });
                    const blobText = new Blob([clone.innerText], { type: "text/plain" });
                    const data = [new ClipboardItem({ "text/html": blobHtml, "text/plain": blobText })];
                    await navigator.clipboard.write(data);
                    showToast("å¤åˆ¶æˆåŠŸï¼");
                    addLog("âœ… å¯Œæ–‡æœ¬å·²å¤åˆ¶");
                } catch (err) {
                    addLog(`âš ï¸ å°è¯•å…¼å®¹æ¨¡å¼...`);
                    try {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = htmlContent;
                        tempDiv.style.position = 'fixed';
                        tempDiv.style.left = '-9999px';
                        tempDiv.style.backgroundColor = 'white';
                        document.body.appendChild(tempDiv);
                        const range = document.createRange();
                        range.selectNodeContents(tempDiv);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                        document.execCommand('copy');
                        document.body.removeChild(tempDiv);
                        selection.removeAllRanges();
                        showToast("å·²å¤åˆ¶ (å…¼å®¹æ¨¡å¼)");
                    } catch (e) {
                        showToast("å¤åˆ¶å¤±è´¥");
                    }
                }
            };

            // Fixed: Clone Node method for complete full-page screenshot
            const exportLongImage = async () => {
                if (!previewRef.current) return;
                addLog("ğŸ–¼ï¸ æ­£åœ¨ç”Ÿæˆå…¨é‡é•¿å›¾...");
                
                try {
                    const element = previewRef.current;
                    const clone = element.cloneNode(true);
                    
                    // Force clone to full height and visible
                    clone.style.position = 'fixed';
                    clone.style.left = '-9999px';
                    clone.style.top = '0';
                    clone.style.width = `${element.offsetWidth}px`;
                    clone.style.height = 'auto';
                    clone.style.overflow = 'visible';
                    clone.style.zIndex = '-1000';
                    
                    document.body.appendChild(clone);
                    
                    // Wait for render
                    await new Promise(r => setTimeout(r, 500));

                    const canvas = await html2canvas(clone, {
                        useCORS: true,
                        scale: 2,
                        backgroundColor: '#ffffff',
                        height: clone.scrollHeight, // Capture full height
                        windowHeight: clone.scrollHeight
                    });
                    
                    document.body.removeChild(clone);
                    
                    const link = document.createElement('a');
                    link.download = `wechat-export-${Date.now()}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    addLog("âœ… é•¿å›¾å·²å¯¼å‡º");
                } catch (err) {
                    addLog(`âŒ å¯¼å‡ºå¤±è´¥: ${err.message}`);
                }
            };

            return (
                <div className="flex h-screen w-full overflow-hidden">
                    <Toast message={toast.msg} show={toast.show} />

                    {/* Left Panel */}
                    <div className="w-[40%] h-full bg-surface border-r border-[var(--w-border-color)] flex flex-col p-6 shadow-xl z-10 overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-2xl font-bold text-brand flex items-center gap-2">
                                <Icons.Settings /> è‡ªåŠ¨åŒ–å·¥å‚
                            </h1>
                            <div className="flex gap-2">
                                {['classic', 'tech', 'warm', 'dark'].map(t => (
                                    <button 
                                        key={t}
                                        onClick={() => setTheme(t)}
                                        className={`w-6 h-6 rounded-full border border-gray-300 ${theme === t ? 'ring-2 ring-brand' : ''}`}
                                        style={{ backgroundColor: t === 'dark' ? '#333' : t === 'tech' ? '#eff6ff' : t === 'warm' ? '#fffbeb' : '#fff' }}
                                    />
                                ))}
                            </div>
                        </div>

                        <div className="space-y-4 mb-6">
                            <div className="bg-bg rounded-lg p-3 border border-[var(--w-border-color)]">
                                <div className="flex justify-between items-center">
                                    <div className="flex items-center gap-2 text-sm">
                                        <div className={`w-2 h-2 rounded-full ${apiKey ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                        <span className="font-semibold text-text">{apiKey ? 'API å·²å°±ç»ª' : 'æœªé…ç½® API'}</span>
                                    </div>
                                    <button onClick={() => setShowCustomKey(!showCustomKey)} className="text-xs text-brand hover:underline">{showCustomKey ? 'æ”¶èµ·' : 'è®¾ç½®'}</button>
                                </div>
                                {showCustomKey && (
                                    <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} className="w-full mt-2 p-2 rounded bg-white border text-xs outline-none" placeholder="è¾“å…¥ Gemini API Key" />
                                )}
                            </div>

                            <div>
                                <label className="text-xs font-semibold text-text-sec uppercase">æ ¸å¿ƒé€‰é¢˜</label>
                                <textarea value={topic} onChange={(e) => setTopic(e.target.value)} className="w-full mt-1 p-3 rounded-lg bg-bg border border-[var(--w-border-color)] text-text outline-none h-24" placeholder="ä¾‹å¦‚ï¼š2024å¹´AIè¡Œä¸šå‘å±•è¶‹åŠ¿..." />
                            </div>
                            
                            <button onClick={handleStart} disabled={loading} className={`w-full py-3 rounded-lg font-bold text-white flex justify-center items-center gap-2 ${loading ? 'bg-gray-400' : 'bg-brand'}`}>
                                {loading ? <span className="animate-spin">âŒ›</span> : <Icons.Play />}
                                {loading ? "æ­£åœ¨ç”Ÿäº§ä¸­..." : "å¼€å§‹ç”Ÿäº§"}
                            </button>
                        </div>

                        {/* Article Meta Info Area */}
                        {article && (
                            <div className="mb-6 space-y-4 animate-fade-in">
                                <div className="bg-bg p-3 rounded-lg border border-[var(--w-border-color)]">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-xs font-bold text-text-sec uppercase">å¤‡é€‰æ ‡é¢˜ (ç‚¹å‡»åº”ç”¨)</span>
                                    </div>
                                    <div className="space-y-1">
                                        {article.titles.map((t, idx) => (
                                            <div 
                                                key={idx} 
                                                onClick={() => setCurrentTitleIndex(idx)}
                                                className={`text-sm p-2 rounded cursor-pointer transition-colors ${currentTitleIndex === idx ? 'bg-brand text-white' : 'hover:bg-gray-200 text-text'}`}
                                            >
                                                {t}
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="bg-bg p-3 rounded-lg border border-[var(--w-border-color)]">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-xs font-bold text-text-sec uppercase">æ‘˜è¦ (Digest)</span>
                                        <button onClick={copyDigest} className="text-xs text-brand hover:underline">å¤åˆ¶æ‘˜è¦</button>
                                    </div>
                                    <p className="text-sm text-text leading-relaxed">{article.digest}</p>
                                </div>
                            </div>
                        )}

                        <div className="flex-1 bg-[#1e1e1e] rounded-xl p-4 overflow-hidden flex flex-col font-mono text-xs shadow-inner min-h-[150px]">
                            <div className="text-gray-400 border-b border-gray-700 pb-2 mb-2">SYSTEM_LOG</div>
                            <div className="flex-1 overflow-y-auto console-scroll space-y-1">
                                {logs.map((log, i) => <div key={i} className={log.includes('âŒ') ? 'text-red-400' : 'text-green-400'}>{log}</div>)}
                                <div ref={logsEndRef} />
                            </div>
                        </div>
                    </div>

                    {/* Right Panel */}
                    <div className="w-[60%] h-full bg-bg relative flex flex-col items-center justify-center p-8">
                        <div className="w-[375px] h-[812px] bg-white rounded-[40px] shadow-ios border-[8px] border-gray-800 relative overflow-hidden flex flex-col">
                            {/* Status Bar */}
                            <div className="h-10 w-full bg-white flex justify-between items-end px-6 pb-2 text-[10px] font-bold text-black z-10 select-none">
                                <span>9:41</span><div className="flex gap-1"><span>ğŸ“¶</span><span>ğŸ”‹</span></div>
                            </div>

                            {/* Content */}
                            <div className="flex-1 overflow-y-auto no-scrollbar bg-white" ref={previewRef}>
                                {article ? (
                                    <>
                                        <div className="w-full aspect-[2.35/1] bg-gray-200 relative overflow-hidden group">
                                            {article.coverUrl ? (
                                                <img src={article.coverUrl} className="w-full h-full object-cover" alt="Cover" crossOrigin="anonymous" />
                                            ) : (
                                                <div className="w-full h-full flex items-center justify-center text-gray-400 animate-pulse bg-gray-100"><span className="text-xs">å°é¢ç»˜åˆ¶ä¸­...</span></div>
                                            )}
                                            <div className="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-black/70 to-transparent text-white">
                                                <div className="flex items-start gap-2">
                                                    <h1 className="text-lg font-bold leading-tight line-clamp-2 flex-1">{article.titles[currentTitleIndex]}</h1>
                                                    <button onClick={cycleTitle} className="mt-1 p-1 bg-white/20 rounded-full hover:bg-white/40 transition-colors" title="åˆ‡æ¢æ ‡é¢˜">
                                                        <Icons.Refresh />
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="p-5 wx-content pb-20">
                                            {article.sections.map((section, idx) => {
                                                if (section.type === 'text') {
                                                    return <div key={idx} dangerouslySetInnerHTML={{ __html: section.content }} />;
                                                } else {
                                                    return (
                                                        <div key={idx} className="my-6 rounded-lg overflow-hidden shadow-sm">
                                                            {section.url ? (
                                                                <img src={section.url} className="w-full h-auto block" alt="AI Generated" crossOrigin="anonymous" />
                                                            ) : (
                                                                <div className="w-full aspect-video bg-gray-50 flex flex-col items-center justify-center border-2 border-dashed border-gray-200 animate-pulse">
                                                                    <div className="w-8 h-8 border-4 border-brand border-t-transparent rounded-full animate-spin mb-2"></div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                }
                                            })}
                                            <div className="mt-8 pt-8 border-t border-gray-100 text-center text-gray-400 text-xs">- End -</div>
                                        </div>
                                    </>
                                ) : (
                                    <div className="h-full flex flex-col items-center justify-center text-gray-300 space-y-4">
                                        <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-2"><Icons.Settings /></div>
                                        <p>ç­‰å¾…å†…å®¹ç”Ÿæˆ...</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Actions */}
                        {article && !loading && (
                            <div className="absolute bottom-8 right-12 flex flex-col gap-4">
                                <button onClick={copyToWeChat} className="w-14 h-14 bg-white rounded-full shadow-xl flex items-center justify-center text-green-600 hover:scale-110 transition-transform group border border-gray-100" title="å¤åˆ¶åˆ°å¾®ä¿¡">
                                    <Icons.Copy />
                                </button>
                                <button onClick={exportLongImage} className="w-14 h-14 bg-white rounded-full shadow-xl flex items-center justify-center text-blue-600 hover:scale-110 transition-transform group border border-gray-100" title="å¯¼å‡ºé•¿å›¾">
                                    <Icons.Image />
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
