<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeChat Automator Pro - å…¬ä¼—å·è‡ªåŠ¨åŒ–å·¥å‚</title>
    
    <!-- Core Libraries (Switched to cdnjs for better stability) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- Tailwind Config for Custom Colors (Safe Loading Version) -->
    <script>
        (function() {
            // å®šä¹‰é…ç½®å¯¹è±¡
            const myConfig = {
                theme: {
                    extend: {
                        colors: {
                            brand: 'var(--w-accent-color)',
                            bg: 'var(--w-bg-color)',
                            surface: 'var(--w-surface-color)',
                            text: 'var(--w-text-color)',
                            'text-sec': 'var(--w-text-sec-color)',
                        },
                        boxShadow: {
                            'ios': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                        }
                    }
                }
            };

            // å°è¯•åº”ç”¨é…ç½®çš„å®‰å…¨å‡½æ•°
            function applyTailwindConfig() {
                if (typeof tailwind !== 'undefined') {
                    tailwind.config = myConfig;
                }
            }

            // 1. ç«‹å³å°è¯•
            if (typeof tailwind !== 'undefined') {
                applyTailwindConfig();
            } else {
                // 2. å¦‚æœæœªåŠ è½½ï¼Œç›‘å¬ load äº‹ä»¶
                window.addEventListener('load', applyTailwindConfig);
                
                // 3. åŒé‡ä¿é™©ï¼šè®¾ç½®å®šæ—¶å™¨è½®è¯¢æ£€æµ‹ (é’ˆå¯¹æŸäº›ç‰¹æ®Šå¼‚æ­¥ç¯å¢ƒ)
                const checkInterval = setInterval(() => {
                    if (typeof tailwind !== 'undefined') {
                        applyTailwindConfig();
                        clearInterval(checkInterval);
                    }
                }, 100);
                
                // 5ç§’ååœæ­¢è½®è¯¢ä»¥é˜²æ­»å¾ªç¯
                setTimeout(() => clearInterval(checkInterval), 5000);
            }
        })();
    </script>

    <!-- Custom Styles & Variables -->
    <style>
        :root {
            /* Default Theme (Classic White) */
            --w-accent-color: #07c160; /* WeChat Green */
            --w-bg-color: #f3f4f6;
            --w-surface-color: #ffffff;
            --w-text-color: #1f2937;
            --w-text-sec-color: #6b7280;
            --w-border-color: #e5e7eb;
        }

        /* Tech Blue Theme */
        [data-theme="tech"] {
            --w-accent-color: #3b82f6;
            --w-bg-color: #0f172a;
            --w-surface-color: #1e293b;
            --w-text-color: #f1f5f9;
            --w-text-sec-color: #94a3b8;
            --w-border-color: #334155;
        }

        /* Warm/Eye-care Theme */
        [data-theme="warm"] {
            --w-accent-color: #d97706;
            --w-bg-color: #fef3c7;
            --w-surface-color: #fffbeb;
            --w-text-color: #451a03;
            --w-text-sec-color: #92400e;
            --w-border-color: #fde68a;
        }

        /* Dark Mode */
        [data-theme="dark"] {
            --w-accent-color: #8b5cf6;
            --w-bg-color: #18181b;
            --w-surface-color: #27272a;
            --w-text-color: #e4e4e7;
            --w-text-sec-color: #a1a1aa;
            --w-border-color: #3f3f46;
        }

        body {
            background-color: var(--w-bg-color);
            color: var(--w-text-color);
            transition: background-color 0.3s, color 0.3s;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* Scrollbar Styling for Console */
        .console-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .console-scroll::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
        }
        .console-scroll::-webkit-scrollbar-thumb {
            background: var(--w-accent-color);
            border-radius: 3px;
        }

        /* WeChat Preview Content Styles (Crucial for Copy) */
        .wx-content {
            font-size: 16px;
            line-height: 1.75;
            letter-spacing: 0.05em;
            text-align: justify;
            color: #333333;
        }
        .wx-content p {
            margin-bottom: 1.5em;
            min-height: 1em;
        }
        .wx-content h2 {
            font-size: 18px;
            font-weight: bold;
            border-left: 4px solid var(--w-accent-color);
            padding-left: 10px;
            margin-top: 2em;
            margin-bottom: 1em;
            line-height: 1.4;
            color: #000;
        }
        .wx-content blockquote {
            background: #f7f7f7;
            border-radius: 4px;
            padding: 1em;
            margin: 1.5em 0;
            color: #666;
            font-size: 14px;
            border-left: 3px solid #ddd;
        }
        .wx-content strong {
            color: var(--w-accent-color);
            font-weight: 700;
        }
        .wx-content ul {
            padding-left: 1em;
            margin-bottom: 1.5em;
        }
        .wx-content li {
            list-style-type: disc;
            margin-bottom: 0.5em;
            color: #444;
        }
        /* Hide scrollbar for preview */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. Constants & Configuration ---
        // é»˜è®¤Keyç½®ç©ºï¼Œå¼ºåˆ¶ç”¨æˆ·è¾“å…¥ï¼Œå¹¶æ”¯æŒæœ¬åœ°ç¼“å­˜
        const DEFAULT_API_KEY = "";
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        
        // --- 2. Utilities ---

        // Robust Fetch with Retry
        const fetchWithRetry = async (url, options = {}, logCallback, maxRetries = 5) => {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, options);
                    
                    // Handle 429 (Rate Limit) - Soft Error
                    if (response.status === 429) {
                        const waitTime = (attempt + 1) * 5000;
                        logCallback(`âš ï¸ è§¦å‘é™æµ (429)ï¼Œç­‰å¾… ${waitTime/1000}ç§’åç¬¬ ${attempt + 1} æ¬¡é‡è¯•...`);
                        await new Promise(r => setTimeout(r, waitTime));
                        attempt++;
                        continue;
                    }

                    // Handle 502/503 (Server Error) - Soft Error
                    if (response.status >= 500) {
                        const waitTime = Math.pow(2, attempt) * 1000;
                        logCallback(`âš ï¸ æœåŠ¡å™¨ç¹å¿™ (${response.status})ï¼Œç­‰å¾… ${waitTime/1000}ç§’åç¬¬ ${attempt + 1} æ¬¡é‡è¯•...`);
                        await new Promise(r => setTimeout(r, waitTime));
                        attempt++;
                        continue;
                    }

                    // Handle 400/401 (Client Error) - Hard Error
                    if (response.status >= 400 && response.status < 500) {
                        const errText = await response.text();
                        throw new Error(`è¯·æ±‚è¢«æ‹’ç» (${response.status}): ${errText}`);
                    }

                    return response;
                } catch (error) {
                    if (attempt === maxRetries - 1) throw error;
                    // Network errors (offline, etc)
                    const waitTime = Math.pow(2, attempt) * 1000;
                    logCallback(`âš ï¸ ç½‘ç»œé”™è¯¯ (${error.message})ï¼Œ${waitTime/1000}ç§’åé‡è¯•...`);
                    await new Promise(r => setTimeout(r, waitTime));
                    attempt++;
                }
            }
        };

        // --- 3. Icons (Lucide Style) ---
        const Icons = {
            Settings: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Play: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Copy: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
            Image: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>,
            Check: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Theme: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Key: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>,
            Cloud: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.5 19c0-1.7-1.3-3-3-3h-11a3 3 0 0 1-3-3c0-1.7 1.3-3 3-3 0-1.4 0-2.8.3-4.1A6 6 0 0 1 12 5c2.9 0 5.4 2 6 4.9 2.5.3 4.5 2.5 4.5 5.1 0 2.8-2.2 5-5 5z"/></svg>
        };

        // --- 4. Main Components ---

        const Toast = ({ message, show }) => {
            if (!show) return null;
            return (
                <div className="fixed top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg z-50 flex items-center gap-2 animate-bounce">
                    <Icons.Check />
                    <span>{message}</span>
                </div>
            );
        };

        const App = () => {
            // ä» LocalStorage åŠ è½½ API Keyï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸ºç©º
            const [apiKey, setApiKey] = React.useState(() => localStorage.getItem('wechat_automator_api_key') || "");
            // å¦‚æœæ²¡æœ‰ API Keyï¼Œé»˜è®¤å±•å¼€è®¾ç½®é¢æ¿
            const [showCustomKey, setShowCustomKey] = React.useState(() => !localStorage.getItem('wechat_automator_api_key'));
            const [topic, setTopic] = React.useState("");
            const [logs, setLogs] = React.useState([]);
            const [loading, setLoading] = React.useState(false);
            const [article, setArticle] = React.useState(null); // { title, coverUrl, sections: [] }
            const [theme, setTheme] = React.useState('classic');
            const [toast, setToast] = React.useState({ show: false, msg: '' });

            const logsEndRef = React.useRef(null);
            const previewRef = React.useRef(null);

            // Auto-scroll logs
            React.useEffect(() => {
                logsEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [logs]);

            // Theme Effect
            React.useEffect(() => {
                document.body.setAttribute('data-theme', theme);
            }, [theme]);

            // Save API Key to LocalStorage whenever it changes
            React.useEffect(() => {
                if (apiKey) {
                    localStorage.setItem('wechat_automator_api_key', apiKey);
                } else {
                    localStorage.removeItem('wechat_automator_api_key');
                }
            }, [apiKey]);

            const addLog = (msg) => {
                const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
                setLogs(prev => [...prev, `[${time}] ${msg}`]);
            };

            const showToast = (msg) => {
                setToast({ show: true, msg });
                setTimeout(() => setToast({ show: false, msg: '' }), 3000);
            };

            // Image Generator (Flux via Pollinations)
            const generateImage = async (prompt, isCover = false) => {
                // Enhance prompt
                const enhancedPrompt = `${prompt}, high quality, 8k, realistic, detailed, photorealistic`;
                const seed = Math.floor(Math.random() * 1000000);
                const width = isCover ? 1080 : 1280;
                const height = isCover ? 460 : 720; // Cover 2.35:1, others 16:9
                const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(enhancedPrompt)}?width=${width}&height=${height}&seed=${seed}&nologo=true&model=flux`;

                addLog(`ğŸ¨ å¼€å§‹ç»˜åˆ¶${isCover ? 'å°é¢' : 'æ’å›¾'}: ${prompt.substring(0, 15)}...`);

                // We verify the image works by fetching the blob
                try {
                    const res = await fetchWithRetry(url, {}, addLog);
                    if (!res.ok) throw new Error("Image fetch failed");
                    const blob = await res.blob();
                    const objectUrl = URL.createObjectURL(blob);
                    addLog(`âœ… ${isCover ? 'å°é¢' : 'æ’å›¾'}ç»˜åˆ¶æˆåŠŸ`);
                    return objectUrl;
                } catch (e) {
                    addLog(`âŒ ç»˜å›¾å¤±è´¥ï¼Œä½¿ç”¨å ä½å›¾: ${e.message}`);
                    // Fallback generic SVG
                    return `data:image/svg+xml;charset=UTF-8,%3Csvg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg"%3E%3Crect width="100%25" height="100%25" fill="%23eee"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="24" fill="%23aaa"%3EImage Generation Failed%3C/text%3E%3C/svg%3E`;
                }
            };

            const handleStart = async () => {
                if (!topic) return showToast("è¯·è¾“å…¥é€‰é¢˜");
                // ä»…ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ Key
                const currentKey = apiKey;
                if (!currentKey) {
                    setShowCustomKey(true); // è‡ªåŠ¨å±•å¼€è®¾ç½®
                    return showToast("è¯·å…ˆé…ç½® API Key");
                }
                
                setLoading(true);
                setLogs([]);
                setArticle(null);
                addLog("ğŸš€ ä»»åŠ¡å¯åŠ¨...");

                try {
                    // 1. Text Generation
                    addLog("ğŸ§  Gemini æ­£åœ¨æ„æ€å¤§çº²ä¸æ­£æ–‡...");
                    
                    const systemPrompt = `
                    ä½ æ˜¯ä¸€ä¸ªæ“…é•¿è®²æ•…äº‹ã€æ–‡ç¬”æä½³çš„å¾®ä¿¡å…¬ä¼—å·ä¸»ç†äººã€‚è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„ã€Topicã€‘åˆ›ä½œä¸€ç¯‡é«˜è´¨é‡å›¾æ–‡ã€‚

                    ã€é£æ ¼åŸºè°ƒã€‘ï¼š
                    1. **è€å‹èŠå¤©é£**ï¼šè¯­æ°”è¦éå¸¸è½»æ¾ã€èˆ’é€‚ï¼Œå°±åƒå’Œå¥½æœ‹å‹åœ¨å’–å•¡é¦†æˆ–æ·±å¤œèŠå¤©ä¸€æ ·ã€‚ä¸è¦ç«¯ç€æ¶å­ï¼Œä¸è¦åƒå†™è®ºæ–‡æˆ–æ•™ç§‘ä¹¦ã€‚ç”¨è¯è¦å£è¯­åŒ–ã€æ¥åœ°æ°”ã€‚
                    2. **æ•…äº‹ä¸ºä¸»**ï¼šå…¨ç¯‡å¿…é¡»ç”±ç”ŸåŠ¨çš„**çœŸå®æ•…äº‹**ã€**ç”Ÿæ´»ç»†èŠ‚**æˆ–**å…·ä½“åœºæ™¯**ä¸²è”ã€‚ä¸è¦ä¸€ä¸Šæ¥å°±è®²å¤§é“ç†ï¼Œè¦ç”¨æ•…äº‹è®©è¯»è€…è‡ªå·±æ„Ÿæ‚Ÿã€‚
                    3. **å°‘è®²é“ç†**ï¼šé“ç†åªå 20%ï¼Œæ•…äº‹å’Œæƒ…æ„Ÿå 80%ã€‚é“ç†è¦ç‚¹åˆ°ä¸ºæ­¢ï¼Œé‡‘å¥è¦æ¸©å’Œè€Œæœ‰ç©¿é€åŠ›ï¼Œæ‹’ç»çˆ¹å‘³è¯´æ•™ã€‚
                    4. **æƒ…æ„Ÿå…±é¸£**ï¼šå…³æ³¨è¯»è€…çš„æƒ…ç»ªï¼Œå¤šç”¨â€œä½ â€ã€â€œæˆ‘ä»¬â€ï¼Œæ‹‰è¿‘è·ç¦»ã€‚

                    ã€æ ¸å¿ƒæŒ‡ä»¤ã€‘ï¼š
                    1. **ä¸€è‡´æ€§é“å¾‹**ï¼šå¦‚æœæ ‡é¢˜åŒ…å«æ•°å­—ï¼ˆå¦‚â€œ3ä¸ªä¹ æƒ¯â€ï¼‰ï¼Œæ­£æ–‡çš„æ•…äº‹å’Œè§‚ç‚¹æ•°é‡å¿…é¡»ä¸¥æ ¼å¯¹åº”ã€‚
                    2. æ ‡é¢˜å¿…é¡»**å¸å¼•äºº**ï¼Œå¯ä»¥èµ°æ¸©æƒ…ã€æ‰å¿ƒã€æ²»æ„ˆæˆ–åç›´è§‰è·¯çº¿ï¼Œé¿å…è¿‡äºå¤¸å¼ çš„éœ‡æƒŠä½“ã€‚
                    
                    ã€æ’ç‰ˆæ ¼å¼ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰ã€‘ï¼š
                    1. è¿”å›ä¸¥æ ¼çš„ JSON æ ¼å¼ã€‚
                    2. **ä¸¥ç¦ Markdown**ï¼šç»å¯¹ä¸è¦ä½¿ç”¨æ˜Ÿå· \`**\` æ¥åŠ ç²—ï¼Œä¹Ÿåˆ«ç”¨ \`##\` åšæ ‡é¢˜ã€‚
                    3. **å¿…é¡»ä½¿ç”¨ HTML**ï¼š
                       - åŠ ç²—ä½¿ç”¨ <strong>...</strong>
                       - äºŒçº§æ ‡é¢˜ä½¿ç”¨ <h2>...</h2>
                       - å¼•ç”¨é‡‘å¥ä½¿ç”¨ <blockquote>...</blockquote>
                       - åˆ—è¡¨ä½¿ç”¨ <ul><li>...</li></ul>
                    
                    ã€ç»“æ„è¦æ±‚ã€‘ï¼š
                    1. åŒ…å« 'topic', 'titles' (5ä¸ªç²¾é€‰æ ‡é¢˜æ•°ç»„), 'coverPrompt' (è‹±æ–‡å°é¢æç¤ºè¯), 'sections' (å†…å®¹æ•°ç»„)ã€‚
                    2. sections æ•°ç»„å…ƒç´ ç»“æ„: { "type": "text" | "image_prompt", "content": "string" }ã€‚
                    3. æ–‡æœ¬é•¿åº¦ 1500-2000 å­—ã€‚
                    4. å›¾ç‰‡æç¤ºè¯ (image_prompt) éœ€æ ¹æ®ä¸Šä¸‹æ–‡ç©¿æ’åœ¨æ–‡æœ¬ä¸­ï¼Œç”¨äºåç»­AIç”Ÿå›¾ã€‚
                    5. è¾“å‡ºå¿…é¡»æ˜¯çº¯ JSONï¼Œä¸è¦æœ‰ \`\`\`json æ ‡è®°ã€‚
                    `;

                    const response = await fetchWithRetry(
                        `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${currentKey}`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: `Topic: ${topic}` }] }],
                                systemInstruction: { parts: [{ text: systemPrompt }] },
                                generationConfig: { responseMimeType: "application/json" }
                            })
                        },
                        addLog
                    );

                    const data = await response.json();
                    const resultText = data.candidates[0].content.parts[0].text;
                    let parsedData = JSON.parse(resultText);

                    // --- æ–°å¢ï¼šæ•°æ®æ¸…æ´—ä¸å®¹é”™å¤„ç† ---
                    // é˜²æ­¢ AI å¶å°”ä¸å¬è¯è¾“å‡ºäº† Markdown ç¬¦å·ï¼Œå‰ç«¯å¼ºåˆ¶æ›¿æ¢ä¸º HTML
                    if (parsedData.sections) {
                        parsedData.sections = parsedData.sections.map(section => {
                            if (section.type === 'text') {
                                let cleanContent = section.content;
                                // æ›¿æ¢MarkdownåŠ ç²— **text** -> <strong>text</strong>
                                cleanContent = cleanContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                                // æ›¿æ¢Markdownæ ‡é¢˜ ## text -> <h2>text</h2>
                                cleanContent = cleanContent.replace(/^##\s+(.*$)/gm, '<h2>$1</h2>');
                                // æ›¿æ¢Markdownåˆ—è¡¨ * text -> <li>text</li> (ç®€å•å¤„ç†)
                                cleanContent = cleanContent.replace(/^\*\s+(.*$)/gm, '<ul><li>$1</li></ul>');
                                return { ...section, content: cleanContent };
                            }
                            return section;
                        });
                    }

                    addLog("ğŸ“ æ–‡æ¡ˆç”Ÿæˆå®Œæ¯•ï¼Œå‡†å¤‡æ¸²æŸ“...");
                    
                    // Initial State Setup with placeholders
                    const initialSections = parsedData.sections.map((s, i) => ({
                        ...s,
                        id: i,
                        isLoading: s.type === 'image_prompt',
                        url: null
                    }));

                    setArticle({
                        title: parsedData.titles[0],
                        coverUrl: null, // Loading
                        coverPrompt: parsedData.coverPrompt,
                        sections: initialSections
                    });

                    // 2. Image Generation Pipeline (Sequential)
                    
                    // Cover
                    const coverUrl = await generateImage(parsedData.coverPrompt, true);
                    setArticle(prev => ({ ...prev, coverUrl }));
                    
                    // Body Images
                    for (let i = 0; i < initialSections.length; i++) {
                        const section = initialSections[i];
                        if (section.type === 'image_prompt') {
                            // Delay to prevent browser/api choke
                            await new Promise(r => setTimeout(r, 1000));
                            const imgUrl = await generateImage(section.content, false);
                            
                            setArticle(prev => ({
                                ...prev,
                                sections: prev.sections.map(s => s.id === section.id ? { ...s, url: imgUrl, isLoading: false } : s)
                            }));
                        }
                    }

                    addLog("âœ¨ å…¨éƒ¨ä»»åŠ¡å®Œæˆï¼");

                } catch (error) {
                    addLog(`âŒ è‡´å‘½é”™è¯¯: ${error.message}`);
                    console.error(error);
                } finally {
                    setLoading(false);
                }
            };

            const copyToWeChat = async () => {
                if (!previewRef.current) return;
                
                addLog("ğŸ“‹ æ­£åœ¨æ ¼å¼åŒ–å¯Œæ–‡æœ¬ (åŒ…å«å›¾ç‰‡è½¬ç )...");
                showToast("æ­£åœ¨å‡†å¤‡å›¾ç‰‡ï¼Œè¯·ç¨å€™...");
                
                // 1. åˆ›å»º DOM å…‹éš†ä»¥è¿›è¡Œæ ·å¼å†…è”å¤„ç†
                const clone = previewRef.current.cloneNode(true);
                
                // --- å…³é”®æ­¥éª¤ï¼šå°†å›¾ç‰‡ URL è½¬æ¢ä¸º Base64 ---
                // å¾®ä¿¡ç¼–è¾‘å™¨ç›´æ¥ç²˜è´´å¤–éƒ¨é“¾æ¥å›¾ç‰‡å¾€å¾€ä¼šå¤±è´¥ï¼Œ
                // è½¬ä¸º Base64 å†…åµŒåˆ° HTML ä¸­æ˜¯è§£å†³"å›¾ç‰‡æ— æ³•ç²˜è´´"æœ€æœ‰æ•ˆçš„æ–¹æ³•ã€‚
                const images = clone.querySelectorAll('img');
                for (let img of images) {
                    try {
                        addLog(`ğŸ”„ æ­£åœ¨è½¬ç å›¾ç‰‡: ${img.src.substring(0, 20)}...`);
                        const response = await fetch(img.src);
                        const blob = await response.blob();
                        const base64 = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result);
                            reader.readAsDataURL(blob);
                        });
                        img.src = base64;
                    } catch (e) {
                        console.warn('Image base64 conversion failed', e);
                        addLog(`âš ï¸ å›¾ç‰‡è½¬ç å¤±è´¥ï¼Œå¯èƒ½æ— æ³•ç²˜è´´: ${e.message}`);
                    }
                }

                // 2. ç§»é™¤æ‰€æœ‰ä¸å¿…è¦çš„ classï¼Œå¹¶æ˜¾å¼åº”ç”¨å†…è”æ ·å¼
                const processStyles = (root) => {
                    const allElements = root.querySelectorAll('*');
                    const brandColor = '#07c160';
                    
                    allElements.forEach(el => {
                        const tagName = el.tagName.toLowerCase();
                        
                        // å…¨å±€é‡ç½®
                        el.removeAttribute('class');
                        
                        // æ ·å¼æ³¨å…¥
                        if (tagName === 'p') {
                            el.style.marginBottom = '1.5em';
                            el.style.lineHeight = '1.75';
                            el.style.fontSize = '16px';
                            el.style.color = '#333333';
                            el.style.textAlign = 'justify';
                        }
                        if (tagName === 'h2') {
                            el.style.fontSize = '18px';
                            el.style.fontWeight = 'bold';
                            el.style.borderLeft = `4px solid ${brandColor}`;
                            el.style.paddingLeft = '10px';
                            el.style.marginTop = '2em';
                            el.style.marginBottom = '1em';
                            el.style.lineHeight = '1.4';
                            el.style.color = '#000000';
                        }
                        if (tagName === 'blockquote') {
                            el.style.background = '#f7f7f7';
                            el.style.borderLeft = '4px solid #dddddd';
                            el.style.padding = '1em';
                            el.style.margin = '1.5em 0';
                            el.style.color = '#666666';
                            el.style.fontSize = '14px';
                            el.style.borderRadius = '4px';
                        }
                        if (tagName === 'strong' || tagName === 'b') {
                            el.style.color = brandColor;
                            el.style.fontWeight = '700';
                        }
                        if (tagName === 'ul') {
                            el.style.paddingLeft = '20px';
                            el.style.margin = '1em 0';
                        }
                        if (tagName === 'li') {
                            el.style.marginBottom = '0.5em';
                            el.style.listStyleType = 'disc';
                        }
                        if (tagName === 'img') {
                            el.style.maxWidth = '100%';
                            el.style.height = 'auto';
                            el.style.display = 'block';
                            el.style.margin = '10px auto';
                            el.style.borderRadius = '6px';
                            // å¾®ä¿¡ç‰¹æ®Šå¤„ç†
                            el.setAttribute('data-src', el.src); 
                        }
                    });
                    
                    root.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif";
                    root.style.fontSize = '16px';
                    root.style.lineHeight = '1.75';
                    root.style.color = '#333333';
                };
                
                processStyles(clone);
                
                const htmlContent = clone.outerHTML;

                try {
                    const blobHtml = new Blob([htmlContent], { type: "text/html" });
                    const blobText = new Blob([clone.innerText], { type: "text/plain" });
                    
                    const data = [new ClipboardItem({ 
                        "text/html": blobHtml, 
                        "text/plain": blobText 
                    })];

                    await navigator.clipboard.write(data);
                    showToast("æ·±åº¦æ ¼å¼åŒ–(å«å›¾ç‰‡)å¤åˆ¶æˆåŠŸï¼");
                    addLog("âœ… å¯Œæ–‡æœ¬(å«å›¾ç‰‡Base64)å·²å¤åˆ¶");
                } catch (err) {
                    addLog(`âš ï¸ API å¤åˆ¶å—é™ï¼Œå°è¯•å…¼å®¹æ¨¡å¼...`);
                    try {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = htmlContent;
                        tempDiv.style.position = 'fixed';
                        tempDiv.style.left = '-9999px';
                        tempDiv.style.backgroundColor = 'white';
                        document.body.appendChild(tempDiv);

                        const range = document.createRange();
                        range.selectNodeContents(tempDiv);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);

                        const successful = document.execCommand('copy');
                        
                        document.body.removeChild(tempDiv);
                        selection.removeAllRanges();

                        if (successful) {
                            showToast("å·²å¤åˆ¶ (å…¼å®¹æ¨¡å¼)");
                            addLog("âœ… å…¼å®¹æ¨¡å¼å¤åˆ¶æˆåŠŸ");
                        } else {
                            throw new Error("æµè§ˆå™¨æ‹’ç»å¤åˆ¶");
                        }
                    } catch (fallbackErr) {
                        addLog(`âŒ å¤åˆ¶å¤±è´¥: ${fallbackErr.message}`);
                        showToast("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æˆªå›¾");
                    }
                }
            };

            const exportLongImage = async () => {
                if (!previewRef.current) return;
                addLog("ğŸ–¼ï¸ æ­£åœ¨ç”Ÿæˆé•¿å›¾...");
                try {
                    const canvas = await html2canvas(previewRef.current, {
                        useCORS: true,
                        scale: 2, // High res
                        backgroundColor: '#ffffff'
                    });
                    
                    const link = document.createElement('a');
                    link.download = `wechat-export-${Date.now()}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    addLog("âœ… é•¿å›¾å·²å¯¼å‡º");
                } catch (err) {
                    addLog(`âŒ å¯¼å‡ºå¤±è´¥: ${err.message}`);
                }
            };

            return (
                <div className="flex h-screen w-full overflow-hidden">
                    <Toast message={toast.msg} show={toast.show} />

                    {/* Left Panel: Console */}
                    <div className="w-[40%] h-full bg-surface border-r border-[var(--w-border-color)] flex flex-col p-6 shadow-xl z-10">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-2xl font-bold text-brand flex items-center gap-2">
                                <Icons.Settings /> è‡ªåŠ¨åŒ–å·¥å‚
                            </h1>
                            <div className="flex gap-2">
                                {['classic', 'tech', 'warm', 'dark'].map(t => (
                                    <button 
                                        key={t}
                                        onClick={() => setTheme(t)}
                                        className={`w-6 h-6 rounded-full border border-gray-300 ${theme === t ? 'ring-2 ring-brand' : ''}`}
                                        style={{ backgroundColor: t === 'dark' ? '#333' : t === 'tech' ? '#eff6ff' : t === 'warm' ? '#fffbeb' : '#fff' }}
                                        title={`åˆ‡æ¢ä¸»é¢˜: ${t}`}
                                    />
                                ))}
                            </div>
                        </div>

                        {/* Input Area */}
                        <div className="space-y-4 mb-6">
                            {/* Refactored API Key UI */}
                            <div className="bg-bg rounded-lg p-3 border border-[var(--w-border-color)]">
                                <div className="flex justify-between items-center">
                                    <div className="flex items-center gap-2 text-sm">
                                        <div className={`w-2 h-2 rounded-full ${apiKey ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                        <span className="font-semibold text-text">
                                            {apiKey ? 'API Key å·²å°±ç»ª' : 'æœªé…ç½® API Key'}
                                        </span>
                                        <Icons.Cloud />
                                    </div>
                                    <button 
                                        onClick={() => setShowCustomKey(!showCustomKey)}
                                        className="text-xs text-brand hover:underline font-medium"
                                    >
                                        {showCustomKey ? 'æ”¶èµ·è®¾ç½®' : 'è®¾ç½® Key'}
                                    </button>
                                </div>
                                
                                {showCustomKey && (
                                    <div className="mt-3 animate-fade-in">
                                        <input 
                                            type="password" 
                                            value={apiKey}
                                            onChange={(e) => setApiKey(e.target.value)}
                                            className="w-full p-2 rounded bg-white border border-gray-300 text-xs font-mono focus:ring-1 focus:ring-brand outline-none"
                                            placeholder="è¾“å…¥æ‚¨çš„ Gemini API Key"
                                        />
                                        <p className="text-[10px] text-gray-400 mt-1">Key å°†è‡ªåŠ¨ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ç¼“å­˜ä¸­</p>
                                    </div>
                                )}
                            </div>

                            <div>
                                <label className="text-xs font-semibold text-text-sec uppercase tracking-wider">æ ¸å¿ƒé€‰é¢˜</label>
                                <textarea 
                                    value={topic}
                                    onChange={(e) => setTopic(e.target.value)}
                                    className="w-full mt-1 p-3 rounded-lg bg-bg border border-[var(--w-border-color)] text-text focus:ring-2 focus:ring-brand outline-none transition-all resize-none h-24"
                                    placeholder="ä¾‹å¦‚ï¼š2024å¹´AIè¡Œä¸šå‘å±•è¶‹åŠ¿åˆ†æï¼Œé£æ ¼è¦çŠ€åˆ©..."
                                />
                            </div>
                            <button 
                                onClick={handleStart}
                                disabled={loading}
                                className={`w-full py-3 rounded-lg font-bold text-white flex justify-center items-center gap-2 transition-all transform active:scale-95 ${loading ? 'bg-gray-400 cursor-not-allowed' : 'bg-brand hover:brightness-110 shadow-lg'}`}
                            >
                                {loading ? <span className="animate-spin">âŒ›</span> : <Icons.Play />}
                                {loading ? "æ­£åœ¨ç”Ÿäº§ä¸­..." : "å¼€å§‹ç”Ÿäº§"}
                            </button>
                        </div>

                        {/* System Logs */}
                        <div className="flex-1 bg-[#1e1e1e] rounded-xl p-4 overflow-hidden flex flex-col font-mono text-xs shadow-inner">
                            <div className="flex items-center justify-between text-gray-400 border-b border-gray-700 pb-2 mb-2">
                                <span>SYSTEM_LOG</span>
                                <div className="flex gap-1">
                                    <div className="w-2 h-2 rounded-full bg-red-500"></div>
                                    <div className="w-2 h-2 rounded-full bg-yellow-500"></div>
                                    <div className="w-2 h-2 rounded-full bg-green-500"></div>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto console-scroll space-y-1">
                                {logs.length === 0 && <span className="text-gray-600">ç­‰å¾…ä»»åŠ¡æŒ‡ä»¤...</span>}
                                {logs.map((log, i) => (
                                    <div key={i} className={`${log.includes('âŒ') ? 'text-red-400' : log.includes('âš ï¸') ? 'text-yellow-400' : 'text-green-400'}`}>
                                        {log}
                                    </div>
                                ))}
                                <div ref={logsEndRef} />
                            </div>
                        </div>
                    </div>

                    {/* Right Panel: Preview */}
                    <div className="w-[60%] h-full bg-bg relative flex flex-col items-center justify-center p-8">
                        
                        {/* Mobile Device Mockup */}
                        <div className="w-[375px] h-[812px] bg-white rounded-[40px] shadow-ios border-[8px] border-gray-800 relative overflow-hidden flex flex-col transform transition-transform duration-500 hover:scale-105">
                            {/* Notch */}
                            <div className="absolute top-0 left-1/2 transform -translate-x-1/2 w-[150px] h-[24px] bg-gray-800 rounded-b-[20px] z-20"></div>
                            
                            {/* Status Bar Mock */}
                            <div className="h-10 w-full bg-white flex justify-between items-end px-6 pb-2 text-[10px] font-bold text-black z-10 select-none">
                                <span>9:41</span>
                                <div className="flex gap-1">
                                    <span>ğŸ“¶</span><span>ğŸ”‹</span>
                                </div>
                            </div>

                            {/* Content Area */}
                            <div className="flex-1 overflow-y-auto no-scrollbar bg-white" ref={previewRef}>
                                {article ? (
                                    <>
                                        {/* Cover Image */}
                                        <div className="w-full aspect-[2.35/1] bg-gray-200 relative overflow-hidden group">
                                            {article.coverUrl ? (
                                                <img src={article.coverUrl} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" alt="Cover" crossOrigin="anonymous" />
                                            ) : (
                                                <div className="w-full h-full flex items-center justify-center text-gray-400 animate-pulse bg-gray-100">
                                                    <span className="text-xs">å°é¢ç»˜åˆ¶ä¸­...</span>
                                                </div>
                                            )}
                                            <div className="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-black/70 to-transparent text-white">
                                                <h1 className="text-lg font-bold leading-tight line-clamp-2">{article.title}</h1>
                                            </div>
                                        </div>

                                        {/* Main Content */}
                                        <div className="p-5 wx-content pb-20">
                                            {article.sections.map((section, idx) => {
                                                if (section.type === 'text') {
                                                    return <div key={idx} dangerouslySetInnerHTML={{ __html: section.content }} />;
                                                } else {
                                                    return (
                                                        <div key={idx} className="my-6 rounded-lg overflow-hidden shadow-sm">
                                                            {section.url ? (
                                                                <img src={section.url} className="w-full h-auto block" alt="AI Generated" crossOrigin="anonymous" />
                                                            ) : (
                                                                <div className="w-full aspect-video bg-gray-50 flex flex-col items-center justify-center border-2 border-dashed border-gray-200 animate-pulse">
                                                                    <div className="w-8 h-8 border-4 border-brand border-t-transparent rounded-full animate-spin mb-2"></div>
                                                                    <span className="text-xs text-gray-400">æ­£åœ¨ç»˜åˆ¶æ’å›¾ {idx}...</span>
                                                                </div>
                                                            )}
                                                            <div className="text-center text-gray-400 text-xs mt-2 italic">
                                                                AI ç”Ÿæˆé…å›¾
                                                            </div>
                                                        </div>
                                                    );
                                                }
                                            })}
                                            
                                            <div className="mt-8 pt-8 border-t border-gray-100 text-center text-gray-400 text-xs">
                                                - End -
                                            </div>
                                        </div>
                                    </>
                                ) : (
                                    <div className="h-full flex flex-col items-center justify-center text-gray-300 space-y-4">
                                        <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-2">
                                            <Icons.Settings />
                                        </div>
                                        <p>ç­‰å¾…å†…å®¹ç”Ÿæˆ...</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Floating Action Bar */}
                        {article && !loading && (
                            <div className="absolute bottom-8 right-12 flex flex-col gap-4">
                                <button 
                                    onClick={copyToWeChat}
                                    className="w-14 h-14 bg-white rounded-full shadow-xl flex items-center justify-center text-green-600 hover:scale-110 transition-transform tooltip-container group border border-gray-100"
                                    title="å¤åˆ¶åˆ°å¾®ä¿¡åå°"
                                >
                                    <Icons.Copy />
                                    <span className="absolute right-16 bg-black text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">
                                        å¤åˆ¶å¯Œæ–‡æœ¬
                                    </span>
                                </button>
                                <button 
                                    onClick={exportLongImage}
                                    className="w-14 h-14 bg-white rounded-full shadow-xl flex items-center justify-center text-blue-600 hover:scale-110 transition-transform tooltip-container group border border-gray-100"
                                    title="å¯¼å‡ºé•¿å›¾"
                                >
                                    <Icons.Image />
                                    <span className="absolute right-16 bg-black text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">
                                        ä¿å­˜é•¿å›¾
                                    </span>
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>